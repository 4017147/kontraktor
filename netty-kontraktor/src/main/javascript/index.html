<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title>Test kontraktor from js</title>
    <script src="kontraktor.js"></script>
    <script src="minbin.js"></script>

    <script src="minbingen.js"></script>

</head>
<body>

<script>
    var basicTests = function() {

        var call = MinBin.obj("call", {
            "args" : MinBin.jarray(["Hello from js"]),
            "method" : "$voidCall",
            "receiverKey" : 1
        });
        Kontraktor.send(call);

        call = MinBin.obj("call", {
            "method" : "$callbackTest",
            "receiverKey" : 1,
            "args" : MinBin.jarray([ "Hello from js with callback", function(result, error) {
                document.write(result);
                document.write("<br>");
                console.log("cb result:"+result);
            }])
        });
        Kontraktor.send(call);

        call = MinBin.obj("call", {
            "method" : "$futureCall",
            "receiverKey" : 1,
            "args" : MinBin.jarray([ "Hello from js with future" ])
        });
        Kontraktor.send(call,true).then( function(r,e) {
            document.write("future invoked: <b>"+r+"</b>");
            document.write("<br>");
        });

        call = MinBin.obj("call", {
            "method" : "$createSession",
            "receiverKey" : 1
        });

        Kontraktor.send(call,true).then( function(r,e) {
            var remoteHandle = r;
            var actorId = r.receiverKey;

            call = MinBin.obj("call", {
                "method" : "$clientSpecific",
                "receiverKey" : actorId,
                "args" : MinBin.jarray([ "ca call", "pokpok" ])
            });
            Kontraktor.send( call, true).then( function(r,e) {
                document.write("client call:<b>"+r+"</b>");
            });

            console.log( r );
        });
    };

    Kontraktor.connect(window.location.hostname,window.location.port,"websocket", function(trueOrError) {
        if ( trueOrError ) {
            basicTests();
            var server = new JWSTestActor(1);
            server.$createSession().then(function (session, e) {
                session.$clientSpecific("A", "B").then(function (r, e) {
                    console.log("wrapper call resulted:" + r);
                });

                session.$pingRound(session); // send remoteRef to server, server calls print => client => to server => print


                var me = new JJSActorInterface();
                Kontraktor.registerLocalActor(me);

                me.$voidCallClient = function (s) {
                    document.write("client called:" + s + "<br>")
                };
                me.$futureCall = function (s) {
                    document.write("Future called");
                    return new KPromise("done");
                };
                me.$sync = function () { /**/
                };
                me.$stop = function () { /**/
                };
                me.$close = function () { /**/
                };

                session.$registerClientActor(me);
            });
        } else {
            document.write("Websocket connection closed:"+trueOrError);
        }
    });


</script>
</body>
</html>