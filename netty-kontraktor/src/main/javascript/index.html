<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title>Test kontraktor from js</title>
    <script src="kontraktor.js"></script>
    <script src="minbin.js"></script>

    <script src="minbingen.js"></script>

</head>
<body>

<script>
    var successCount = 0;
    var basicTests = function() {

        document.write("<br><b>Basics ..</b></b><br>");
        var call = MinBin.obj("call", {
            "args" : MinBin.jarray(["Hello from js"]),
            "method" : "$voidCall",
            "receiverKey" : 1
        });
        Kontraktor.send(call);

        call = MinBin.obj("call", {
            "method" : "$callbackTest",
            "receiverKey" : 1,
            "args" : MinBin.jarray([ "Hello from js with callback", function(result, error) {
                document.write(result);
                document.write("<br>");
                successCount++;
            }])
        });
        Kontraktor.send(call);

        call = MinBin.obj("call", {
            "method" : "$futureCall",
            "receiverKey" : 1,
            "args" : MinBin.jarray([ "Hello from js with future" ])
        });
        Kontraktor.send(call,true).then( function(r,e) {
            document.write("future invoked: <b>"+r+"</b>");
            document.write("<br>");
            successCount++;
        });

        call = MinBin.obj("call", {
            "method" : "$createSession",
            "receiverKey" : 1
        });

        Kontraktor.send(call,true).then( function(r,e) {
            var remoteHandle = r;
            var actorId = r.receiverKey;

            call = MinBin.obj("call", {
                "method" : "$clientSpecific",
                "receiverKey" : actorId,
                "args" : MinBin.jarray([ "ca call", "pokpok" ])
            });
            Kontraktor.send( call, true).then( function(r,e) {
                document.write("client call:<b>"+r+"</b>");
                successCount++;
            });

            console.log( r );
        });
    };

    Kontraktor.connect(window.location.hostname,window.location.port,"websocket", function(trueOrError) {
        if ( trueOrError ) {
            basicTests();
            var server = new JWSTestActor(1);
            server.$createSession().then(function (session_arg, e) {

                var session = session_arg;
                var starttime=(new Date()).getTime();

                server.$createTestEncoding().then(function(testenc) {
                    testenc.hmap( MinBin.jmap({
                        one : 1,
                        two : 2,
                        arr : [1,2,3],
                        string: "aString"
                    })).then(function(resultMap) {
                        if ( resultMap["one"] == 1 &&
                             resultMap["two"] == 2 &&
                             resultMap["arr"] == [1,2,3] &&
                             resultMap["string"] == "aString"
                           ) {
                            successCount++;
                        } else {
                            console.error(resultMap);
                        }
                    });
                });

                session.$sync().then( function(r,e) {

                    document.write("<br><br>sync time (ms):"+(new Date().getTime()-starttime));
                    document.write("<br><br><b>Remoting/RemoteRefs/Client Actor ..</b></b><br>");

                    session.$clientSpecific("A", "B").then(function (r, e) {
                        console.log("wrapper call resulted:" + r);
                        successCount++;
                    });

                    session.$pingRound(session); // send remoteRef to server, server calls print => client => to server => print


                    // instantiate and define actor implemented in JS
                    var me = new JJSActorInterface();
                    Kontraktor.registerLocalActor(me);
                    me.$voidCallClient = function (s) {
                        document.write("client called:" + s + "<br>")
                        successCount++;
                    };
                    me.$futureCall = function (s) {
                        document.write("Future called");
                        successCount++;
                        return new KPromise("done");
                    };
                    me.$testFinished = function() {
                        if ( successCount != 6 ) {
                            document.write("<br><br><h1><font color='red'>Test Error success count:" + successCount +"</font></h1>");
                        } else {
                            document.write("<br><br><h1>Test Finished count (" + successCount +")</h1>");
                        }
                    };
                    me.$sync = function () {
                        return new KPromise("void");
                    };
                    me.$stop = function () {};
                    me.$close = function () {};

                    session.$registerClientActor(me);
                    // end instantiate and define actor implemented in JS

                });
            });
        } else {
            document.write("Websocket connection closed:"+trueOrError);
        }
    });


</script>
</body>
</html>