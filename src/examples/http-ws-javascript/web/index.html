<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title>JS Test</title>
</head>
<body>
<p>

<h1>Kontraktor WebSocket Sample</h1>

    Server Time: <span id="time"></span> <br><br>
    ToDo:<br>
    <div id="todo"></div>

<script src="jsk/jsk.js"></script>

<script>
    var server = null;
    var errCB = function( err ) { console.error(err); };
    jsk.connect("ws://localhost:8080/ws",errCB)
      .then( function( app, error ) {
        if ( ! app ) {
            console.log("connection failure");
            console.error(error);
        }
        server = app;

        server.sendWithPromise("login", "clientuser", "clientpwd")
          .then( function(mySession,err) {
            if ( err )
                console.log(err);
            else {
                mySession.sendWithPromise("getToDo").then( function( res,err ) {
                    var li = "<ul>";
                    for ( var i=0; i < res.length; i++ )
                        li += "<li>"+res[i]+"</li>";
                    li += "</ul>";
                    document.getElementById("todo").innerHTML=li;
                });
                server.sendWithPromise("getServerTime").then( function( res,err ) {
                    var tim = document.getElementById("time");
                    tim.innerHTML=res;
                });
                mySession.send( "streamToDo", "p", function( res, err ) {
                      console.log("streamed:"+res+" "+err);
                    }
                );
                mySession.send( "subscribe", function(e,r) {
                    var tim = document.getElementById("time");
                    tim.innerHTML=e;
                    var bright = 1.0;
                    // fadeout bgcolor
                    var fun = function () {
                        tim.style.backgroundColor = "rgba(255,200,100," + bright + ")";
                        bright -= .03;
                        if (bright >= 0.0) {
                            setTimeout(fun,50);
                        }
                    };
                    fun.apply();
                })
            }
        })
    });

</script>
</body>
</html>